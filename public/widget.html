<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Finance Alerts</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  overflow: hidden;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #eaeaea;
}

.safe-zone {
  position: absolute;
  inset: 0;
  overflow: hidden;
  background: rgba(16,16,16,0.96);
}

#content {
  padding: 18px 16px;
  box-sizing: border-box;
}

.section {
  margin-top: 14px;
}
.section-title {
  font-size: 11px;
  letter-spacing: 0.08em;
  opacity: 0.6;
  margin-bottom: 6px;
}

.item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border-radius: 12px;
  margin-bottom: 8px;
  background: rgba(255,255,255,0.085);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.03),
    inset 0 0 18px rgba(0,0,0,0.08),
    0 0 10px rgba(255,255,255,0.18);
}

.item.overdue {
  background: linear-gradient(90deg, rgba(180,60,60,0.28), rgba(255,255,255,0.04));
  --urgent-glow: rgba(255,120,120,0.18);
  --urgent-glow-strong: rgba(255,120,120,0.45);
}

.item.due {
  background: linear-gradient(90deg, rgba(220,150,60,0.24), rgba(255,255,255,0.04));
  --urgent-glow: rgba(255,180,90,0.18);
  --urgent-glow-strong: rgba(255,180,90,0.45);
}

.item.paid {
  background: rgba(120,160,140,0.22);
}

.item.total {
  background: linear-gradient(90deg, rgba(80,140,220,0.35), rgba(255,255,255,0.04));
  --urgent-glow: rgba(120,170,255,0.18);
  --urgent-glow-strong: rgba(120,170,255,0.45);
}

.item-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.item-title {
  font-size: 13px;
  font-weight: 500;
}
.item-sub {
  font-size: 11px;
  opacity: 0.7;
}
.item-right {
  font-size: 13px;
  font-weight: 500;
  opacity: 0.9;
}

@keyframes urgentBreath {
  0% {
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.03),
      inset 0 0 18px rgba(0,0,0,0.08),
      0 0 8px var(--urgent-glow);
    filter: brightness(1);
  }
  50% {
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.06),
      inset 0 0 22px rgba(0,0,0,0.06),
      0 0 18px var(--urgent-glow-strong);
    filter: brightness(1.08);
  }
  100% {
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.03),
      inset 0 0 18px rgba(0,0,0,0.08),
      0 0 8px var(--urgent-glow);
    filter: brightness(1);
  }
}

.item.urgent {
  animation: urgentBreath 1.5s ease-in-out infinite;
}
</style>
</head>

<body>
<div class="safe-zone">
  <div id="content"></div>
</div>

<script>
function renderErrorTile(err) {
  const root = document.getElementById("content");
  if (!root) return;

  root.innerHTML = "";

  const box = document.createElement("div");
  box.className = "item overdue";

  const left = document.createElement("div");
  left.className = "item-left";

  const title = document.createElement("div");
  title.className = "item-title";
  title.textContent = "⚠ Widget Error";

  const sub = document.createElement("div");
  sub.className = "item-sub";
  sub.textContent = err?.message || "Render failed";

  left.appendChild(title);
  left.appendChild(sub);
  box.appendChild(left);
  root.appendChild(box);
}

async function loadData() {
  try {
    const res = await fetch("/api/widget/view?t=" + Date.now(), { cache: "no-store" });
    if (!res.ok) throw new Error("API error " + res.status);
    const data = await res.json();
    render(data);
  } catch (err) {
    console.error(err);
    renderErrorTile(err);
  }
}

function el(tag, cls, txt) {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (txt) e.textContent = txt;
  return e;
}

function formatDate(d) {
  if (!d) return "";
  return new Date(d).toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function formatStatementMonth(v) {
  if (!v || v.length !== 6) return null;
  const d = new Date(v.slice(0,4) + "-" + v.slice(4,6) + "-01");
  if (isNaN(d)) return null;
  return d.toLocaleDateString("en-IN", { month: "short", year: "2-digit" }).replace(" ", "'");
}

function formatINR(v) {
  const n = Number(v);
  return isNaN(n) ? "XXXX" : n.toLocaleString("en-IN");
}

function getTotalPayable(view) {
  return view?.summary?.cards?.total_payable?.amount ?? null;
}

function render(view) {
  try {

  function renderCardSection(title, items, cls) {
    if (!items.length) return;
    const sec = el("div", "section");
    sec.appendChild(el("div", "section-title", title));

    items.forEach(i => {
      const isUrgent =
        i.rules?.urgency === "high" ||
        (i.rules?.urgency === "medium" && cls === "due" && i.days_left <= 2);

      const row = el("div", `item ${cls}${isUrgent ? " urgent" : ""}`);
      const left = el("div", "item-left");

      left.appendChild(el(
        "div",
        "item-title",
        [i.provider, i.last4, i.consumer_name].filter(Boolean).join(" • ")
      ));

      const parts = [
        formatStatementMonth(i.statement_month),
        i.rules?.status_label,
        formatDate(i.due_date)
      ].filter(Boolean);

      left.appendChild(el("div", "item-sub", parts.join(" | ")));
      row.append(left, el("div", "item-right", `₹${formatINR(i.amount_due)}`));
      sec.appendChild(row);
    });

    document.getElementById("content").appendChild(sec);
  }

  try {
    const root = document.getElementById("content");
    root.innerHTML = "";

    const total = getTotalPayable(view);
    if (total !== null) {
      const sec = el("div", "section");
      const row = el("div", `item total${total > 0 ? " urgent" : ""}`);
      row.append(
        el("div", "item-left"),
        el("div", "item-right", `₹${formatINR(total)}`)
      );
      sec.appendChild(row);
      root.appendChild(sec);
    }

    renderCardSection("OVERDUE", view.cards.overdue, "overdue");
    renderCardSection("DUE", view.cards.due, "due");
    renderCardSection(
      "PAID",
      view.cards.paid.filter(i => i.rules.visibility === "visible"),
      "paid"
    );

  } catch (err) {
    console.error("WIDGET RENDER ERROR:", err);
    renderErrorTile(err);
  }
}

requestAnimationFrame(loadData);
document.addEventListener("visibilitychange", () => !document.hidden && loadData());
setInterval(loadData, 15000);

window.addEventListener("error", e => {
  console.error("GLOBAL WIDGET ERROR:", e.error || e.message);
  renderErrorTile(e.error || new Error("Unexpected widget error"));
});
</script>
</body>
</html>
