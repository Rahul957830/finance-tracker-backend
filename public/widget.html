
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Finance Alerts</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: transparent; /* allow Notion to show through */
  overflow: hidden;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #eaeaea;
}

/* ===== SAFE ZONE (MATCHES REACTOR) ===== */
.safe-zone {
  position: absolute;
  inset: 0;
  overflow: hidden;

  /* ðŸ”‘ EXACT reactor-style flat base */
  background: rgba(16,16,16,0.96);
}

/* ===== CONTENT PADDING (NOT CONTAINER) ===== */
#content {
  padding: 18px 16px;
  box-sizing: border-box;
}

/* ===== SECTIONS ===== */
.section {
  margin-top: 14px;
}
.section-title {
  font-size: 11px;
  letter-spacing: 0.08em;
  opacity: 0.6;
  margin-bottom: 6px;
}

/* ===== ITEMS ===== */
.item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border-radius: 12px;
  margin-bottom: 8px;

  background: rgba(255,255,255,0.085);

  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.03),
    inset 0 0 18px rgba(0,0,0,0.08),
    0 0 10px rgba(255,255,255,0.18);
}

.item.overdue {
  background: linear-gradient(
    90deg,
    rgba(180,60,60,0.28),
    rgba(255,255,255,0.04)
  );

  /* ðŸ”´ overdue glow */
  --urgent-glow: rgba(255,120,120,0.18);
  --urgent-glow-strong: rgba(255,120,120,0.45);
}

.item.due {
  background: linear-gradient(
    90deg,
    rgba(220,150,60,0.24),
    rgba(255,255,255,0.04)
  );

  /* ðŸŸ  due glow */
  --urgent-glow: rgba(255,180,90,0.18);
  --urgent-glow-strong: rgba(255,180,90,0.45);
}

.item.paid {
  background: rgba(120,160,140,0.22);
}

.item.total {
  background: linear-gradient(
    90deg,
    rgba(80,140,220,0.35),
    rgba(255,255,255,0.04)
  );

  /* ðŸ”µ total payable glow */
  --urgent-glow: rgba(120,170,255,0.18);
  --urgent-glow-strong: rgba(120,170,255,0.45);
}
  

/* ===== TEXT ===== */
.item-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.item-title {
  font-size: 13px;
  font-weight: 500;
}
.item-sub {
  font-size: 11px;
  opacity: 0.7;
}
.item-right {
  font-size: 13px;
  font-weight: 500;
  opacity: 0.9;
}

/* ===== PAYMENTS ===== */
.payment-day {
  margin-top: 10px;
}
.payment-label {
  font-size: 11px;
  opacity: 0.5;
  margin-bottom: 6px;
}

/* ===== URGENT BREATH (SUBTLE) ===== */
@keyframes urgentBreath {
  0% {
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.03),
      inset 0 0 18px rgba(0,0,0,0.08),
      0 0 8px var(--urgent-glow);
    filter: brightness(1);
  }

  50% {
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.06),
      inset 0 0 22px rgba(0,0,0,0.06),
      0 0 18px var(--urgent-glow-strong);
    filter: brightness(1.08);
  }

  100% {
    box-shadow:
      inset 0 0 0 1px rgba(255,255,255,0.03),
      inset 0 0 18px rgba(0,0,0,0.08),
      0 0 8px var(--urgent-glow);
    filter: brightness(1);
  }
}

/* applies breathing */
.item.urgent {
  animation: urgentBreath 1.5s ease-in-out infinite;
}

  
</style>
</head>

<body>
<div class="safe-zone">
  <div id="content"></div>
</div>

<script>

  function renderErrorTile(message) {
  const root = document.getElementById("content");
  if (!root) return;

  root.innerHTML = "";

  const row = document.createElement("div");
  row.className = "item overdue";

  const left = document.createElement("div");
  left.className = "item-left";

  left.innerHTML = `
    <div class="item-title">âš  Widget Error</div>
    <div class="item-sub">${message}</div>
  `;

  row.appendChild(left);
  root.appendChild(row);
}
async function loadData() {
  try {
    const res = await fetch(
      "/api/widget/view?t=" + Date.now(),
      { cache: "no-store" }
    );

    if (!res.ok) {
      throw new Error("API error " + res.status);
    }

    const data = await res.json();
    render(data);
  } catch (err) {
    console.error(err);
    renderErrorTile("Failed to load data");
  }
}
function el(tag, cls, txt) {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (txt) e.textContent = txt;
  return e;
}
function formatAmount(v) {
  if (v === null || v === undefined || v === "" || v === "XXXX") {
    return "XXXX";
  }
  return `â‚¹${v}`;
}

function formatDate(d) {
  if (!d) return "";
  return new Date(d).toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function formatStatementMonth(v) {
  if (!v || v.length !== 6) return null;

  const year = v.slice(0, 4);
  const month = v.slice(4, 6);

  const d = new Date(`${year}-${month}-01`);
  if (isNaN(d)) return null;

  return d.toLocaleDateString("en-IN", {
    month: "short",
    year: "2-digit",
  }).replace(" ", "'");
}
function formatINR(value) {
  if (
    value === null ||
    value === undefined ||
    value === "" ||
    value === "XXXX"
  ) {
    return "XXXX";
  }
  
  const num = Number(value);
  if (isNaN(num)) return "XXXX";

  return num.toLocaleString("en-IN", {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
}

function getTotalPayable(view) {
  return view?.summary?.cards?.total_payable?.amount ?? null;
}
  
function render(view) {
  try {
  const root = document.getElementById("content");
  root.innerHTML = ""; // âœ… REQUIRED
  const cards = view.cards;

  // ===== TOTAL PAYABLE =====
const totalPayable = getTotalPayable(view);

if (totalPayable !== null) {
  const sec = el("div", "section");

 const row = el(
  "div",
  `item total${totalPayable > 0 ? " urgent" : ""}`
);
  const left = el("div", "item-left");

  left.appendChild(el("div", "item-title", "TOTAL PAYABLE"));
  left.appendChild(el("div", "item-sub", "Across all cards"));

  const right = el(
    "div",
    "item-right",
    `â‚¹${formatINR(totalPayable)}`
  );

  row.append(left, right);
  sec.appendChild(row);
  root.appendChild(sec);
} 
    catch (err) {
    console.error("WIDGET RENDER ERROR:", err);
    renderErrorTile(err);
  }
}

  function renderCardSection(title, items, cls) {
    if (!items.length) return;
    const sec = el("div", "section");
    sec.appendChild(el("div", "section-title", title));
    items.forEach(i => {
    const isUrgent =
  i.rules?.urgency === "high" ||
  (
    i.rules?.urgency === "medium" &&
    cls === "due" &&
    typeof i.days_left === "number" &&
    i.days_left <= 2
  );
const row = el(
  "div",
  `item ${cls}${isUrgent ? " urgent" : ""}`
);
      const left = el("div", "item-left");
     const titleParts = [
  i.provider,
  i.last4,
  i.consumer_name
].filter(Boolean);

left.appendChild(
  el("div", "item-title", titleParts.join(" â€¢ "))
);
      let subText = "";

if (cls === "paid") {
  const monthLabel = formatStatementMonth(i.statement_month);
  const paidAt = formatDate(i.paid_at);
  const method = i.payment_method;

  let icon = "";
  if (method) {
    const m = method.toLowerCase();
    if (m.includes("gpay")) icon = "ðŸŸ¢";
    else if (m.includes("paytm")) icon = "ðŸ”µ";
    else if (m.includes("cred")) icon = "ðŸŸ£";
  }

  const parts = [
  monthLabel,
  paidAt,
  method ? `${icon} ${method}` : null
].filter(Boolean);

subText = parts.join(" | ");
} else {
  const monthLabel = formatStatementMonth(i.statement_month);
  const status = i.rules.status_label || "";
  const dueDate = formatDate(i.due_date);

  const parts = [
    monthLabel,
    status,
    dueDate
  ].filter(Boolean);

  subText = parts.join(" | ");
}

left.appendChild(el("div", "item-sub", subText));
     const right = el("div", "item-right", `â‚¹${formatINR(i.amount_due)}`);
      row.append(left, right);
      sec.appendChild(row);
    });
    root.appendChild(sec);
  }

  renderCardSection("OVERDUE", cards.overdue, "overdue");
  renderCardSection("DUE", cards.due, "due");
  renderCardSection(
    "PAID",
    cards.paid.filter(i => i.rules.visibility === "visible"),
    "paid"
  );

  const payments = view.payments;
  const days = Object.keys(payments);

  if (days.length) {
    const sec = el("div", "section");
    sec.appendChild(el("div", "section-title", "PAYMENTS"));

    days.forEach(day => {
      const group = el("div", "payment-day");
      group.appendChild(el("div", "payment-label", payments[day].label));

      payments[day].items.forEach(p => {
        const row = el("div", "item paid");
        const left = el("div", "item-left");
        left.appendChild(el("div", "item-title", `${p.provider || "Payment"}`));
      // Build subtext in strict order:
// DISPLAY NAME | CONSUMER NAME | CONSUMER NO

const parts = [];

// 1ï¸âƒ£ Display name (highest priority)
if (p.display_name) {
  // Special case: Airtel â†’ show "Airtel Black"
  if (p.display_name.toLowerCase() === "airtel") {
    parts.push("Airtel Black");
  } else {
    parts.push(p.display_name);
  }
}

// 2ï¸âƒ£ Consumer name (only if present & not same as display name)
if (
  p.consumer_name &&
  p.consumer_name !== p.display_name
) {
  parts.push(p.consumer_name);
}

// 3ï¸âƒ£ Consumer number (only if present & not duplicate)
if (
  p.ca_number &&
  p.ca_number !== p.display_name &&
  p.ca_number !== p.consumer_name
) {
  parts.push(p.ca_number);
}

left.appendChild(
  el("div", "item-sub", parts.join(" | "))
);
       const right = el("div", "item-right", `â‚¹${formatINR(p.value)}`);
        row.append(left, right);
        group.appendChild(row);
      });

      sec.appendChild(group);
    });

    root.appendChild(sec);
  }
}

function renderErrorTile(err) {
  const root = document.getElementById("content");
  if (!root) return;

  root.innerHTML = "";

  const box = document.createElement("div");
  box.className = "item overdue";

  const left = document.createElement("div");
  left.className = "item-left";

  const title = document.createElement("div");
  title.className = "item-title";
  title.textContent = "âš  Widget Error";

  const sub = document.createElement("div");
  sub.className = "item-sub";
  sub.textContent = err?.message || "Render failed";

  left.appendChild(title);
  left.appendChild(sub);
  box.appendChild(left);
  root.appendChild(box);
}

/* ================= AUTO REFRESH ================= */

// 1ï¸âƒ£ First fetch after initial paint
requestAnimationFrame(loadData);

// 2ï¸âƒ£ Refresh when user comes back to Notion tab / page
document.addEventListener("visibilitychange", () => {
  if (!document.hidden) {
    loadData();
  }
});

// 3ï¸âƒ£ Poll KV regularly (near-real-time updates)
setInterval(loadData, 15000); // every 15 seconds
  
// 4ï¸âƒ£ Catch silent JS crashes (global safety net)
window.addEventListener("error", (e) => {
  console.error("GLOBAL WIDGET ERROR:", e.error || e.message);
  renderErrorTile(e.error || new Error("Unexpected widget error"));
});
  
</script>
</body>
</html>
