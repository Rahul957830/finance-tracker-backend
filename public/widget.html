<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Finance Alerts</title>

<style>
html, body {
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: transparent;
  overflow: hidden;
  font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  color: #eaeaea;
}

/* ===== SAFE ZONE ===== */
.safe-zone {
  position: absolute;
  inset: 0;
  background: rgba(16,16,16,0.96);
  overflow: hidden;
}

/* ===== CONTENT ===== */
#content {
  padding: 18px 16px;
  box-sizing: border-box;
}

/* ===== SECTIONS ===== */
.section {
  margin-top: 14px;
}

.section-title {
  font-size: 11px;
  letter-spacing: 0.08em;
  opacity: 0.6;
  margin-bottom: 6px;
}

/* ===== FIXED VIEWPORT (4 tiles) ===== */
.section-window {
  height: 208px; /* 4 tiles × (48px + gap) approx */
  overflow: hidden;
  position: relative;
  cursor: grab;
}

/* ===== MOVING RAIL ===== */
.section-rail {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
}

/* ===== ITEMS ===== */
.item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  border-radius: 12px;
  margin-bottom: 8px;
  background: rgba(255,255,255,0.04);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.03),
    inset 0 0 18px rgba(0,0,0,0.5);
}

.item.overdue {
  background: linear-gradient(90deg, rgba(180,60,60,0.28), rgba(255,255,255,0.04));
}
.item.due {
  background: linear-gradient(90deg, rgba(220,150,60,0.24), rgba(255,255,255,0.04));
}
.item.paid {
  background: rgba(120,160,140,0.18);
}

/* ===== TEXT ===== */
.item-left {
  display: flex;
  flex-direction: column;
  gap: 2px;
}
.item-title {
  font-size: 13px;
  font-weight: 500;
}
.item-sub {
  font-size: 11px;
  opacity: 0.7;
}
.item-right {
  font-size: 13px;
  font-weight: 500;
}
</style>
</head>

<body>
<div class="safe-zone">
  <div id="content"></div>
</div>

<script>
const MAX_VISIBLE = 4;
const SPEED = 0.35;

async function loadData() {
  const res = await fetch("/api/widget/view", { cache: "no-store" });
  const data = await res.json();
  render(data);
}

function el(tag, cls, txt) {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (txt) e.textContent = txt;
  return e;
}

/* ===== AUTO SCROLL ENGINE ===== */
function enableLoopScroll(windowEl, railEl) {
  let y = 0;
  let paused = false;
  let dragging = false;
  let startY = 0;
  let startOffset = 0;
  const halfHeight = railEl.scrollHeight / 2;

  windowEl.addEventListener("mouseenter", () => paused = true);
  windowEl.addEventListener("mouseleave", () => paused = false);

  windowEl.addEventListener("mousedown", e => {
    dragging = true;
    paused = true;
    startY = e.clientY;
    startOffset = y;
    windowEl.style.cursor = "grabbing";
  });

  window.addEventListener("mousemove", e => {
    if (!dragging) return;
    y = startOffset + (e.clientY - startY);
  });

  window.addEventListener("mouseup", () => {
    if (!dragging) return;
    dragging = false;
    paused = false;
    windowEl.style.cursor = "grab";
  });

  function loop() {
    if (!paused && !dragging) {
      y -= SPEED;
      if (-y >= halfHeight) y = 0;
    }
    railEl.style.transform = `translateY(${y}px)`;
    requestAnimationFrame(loop);
  }
  loop();
}

/* ===== RENDER ===== */
function render(view) {
  const root = document.getElementById("content");
  root.innerHTML = "";

  function renderSection(title, items, cls) {
    if (!items.length) return;

    const sec = el("div", "section");
    sec.appendChild(el("div", "section-title", title));

    const windowEl = el("div", "section-window");
    const rail = el("div", "section-rail");

    const slice = items.slice(0, MAX_VISIBLE);

    [...slice, ...slice].forEach(i => {
      const row = el("div", `item ${cls}`);
      const left = el("div", "item-left");
      left.appendChild(el("div", "item-title", `${i.provider} • ${i.last4}`));
      left.appendChild(el("div", "item-sub", i.rules.status_label));
      const right = el("div", "item-right", i.amount_due ? `₹${i.amount_due}` : "");
      row.append(left, right);
      rail.appendChild(row);
    });

    windowEl.appendChild(rail);
    sec.appendChild(windowEl);
    root.appendChild(sec);

    enableLoopScroll(windowEl, rail);
  }

  renderSection("OVERDUE", view.cards.overdue, "overdue");
  renderSection("DUE", view.cards.due, "due");
  renderSection(
    "PAID",
    view.cards.paid.filter(i => i.rules.visibility === "visible"),
    "paid"
  );

  const paymentsFlat = Object.values(view.payments).flatMap(d => d.items);
  renderSection("PAYMENTS", paymentsFlat, "paid");
}

loadData();
</script>
</body>
</html>
