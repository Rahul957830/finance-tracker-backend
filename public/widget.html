<script>
/* ================= FETCH ================= */
async function loadData() {
  const res = await fetch("/api/widget/view", { cache: "no-store" });
  const data = await res.json();
  console.log("WIDGET VIEW DATA ðŸ‘‰", data);
  render(data);
}

/* ================= HELPERS ================= */
function el(tag, cls, txt) {
  const e = document.createElement(tag);
  if (cls) e.className = cls;
  if (txt !== undefined) e.textContent = txt;
  return e;
}

function formatDate(d) {
  if (!d) return "";
  return new Date(d).toLocaleDateString("en-GB", {
    day: "2-digit",
    month: "short",
    year: "numeric"
  });
}

function formatINR(value) {
  if (value === null || value === undefined || value === "" || value === "XXXX") {
    return "XXXX";
  }
  const num = Number(value);
  if (isNaN(num)) return "XXXX";
  return num.toLocaleString("en-IN", {
    minimumFractionDigits: 0,
    maximumFractionDigits: 2
  });
}

function getTotalPayable(view) {
  return view?.summary?.cards?.total_payable?.amount ?? null;
}

/* ================= RENDER ================= */
function render(view) {
  const root = document.getElementById("content");
  if (!root) return; // âœ… SAFETY GUARD

  root.innerHTML = "";

  const frag = document.createDocumentFragment();
  const cards = view.cards || { overdue: [], due: [], paid: [] };

  /* ===== TOTAL PAYABLE ===== */
  const totalPayable = getTotalPayable(view);
  if (totalPayable !== null) {
    const sec = el("div", "section");
    const row = el("div", "item total");
    const left = el("div", "item-left");

    left.appendChild(el("div", "item-title", "TOTAL PAYABLE"));
    left.appendChild(el("div", "item-sub", "Across all accounts"));

    row.append(left, el("div", "item-right", `â‚¹${formatINR(totalPayable)}`));
    sec.appendChild(row);
    frag.appendChild(sec);
  }

  function renderCardSection(title, items, cls) {
    if (!items?.length) return;

    const sec = el("div", "section");
    sec.appendChild(el("div", "section-title", title));

    for (const i of items) {
      const row = el("div", `item ${cls}`);
      const left = el("div", "item-left");

      const titleParts = [i.provider, i.last4, i.consumer_name].filter(Boolean);
      left.appendChild(el("div", "item-title", titleParts.join(" â€¢ ")));

      let subText = "";
      if (cls === "paid") {
        const paidAt = formatDate(i.paid_at);
        const method = i.payment_method;
        subText = paidAt && method ? `${paidAt} | ${method}` : paidAt || "";
      } else {
        const status = i.rules?.status_label || "";
        const dueDate = formatDate(i.due_date);
        subText = dueDate ? `${status} | ${dueDate}` : status;
      }

      left.appendChild(el("div", "item-sub", subText));
      row.append(left, el("div", "item-right", `â‚¹${formatINR(i.amount_due)}`));
      sec.appendChild(row);
    }

    frag.appendChild(sec);
  }

  renderCardSection("OVERDUE", cards.overdue, "overdue");
  renderCardSection("DUE", cards.due, "due");
  renderCardSection(
    "PAID",
    (cards.paid || []).filter(i => i.rules?.visibility === "visible"),
    "paid"
  );

  /* ===== PAYMENTS ===== */
  const payments = view.payments || {};
  const days = Object.keys(payments);

  if (days.length) {
    const sec = el("div", "section");
    sec.appendChild(el("div", "section-title", "PAYMENTS"));

    for (const day of days) {
      const group = el("div", "payment-day");
      group.appendChild(el("div", "payment-label", payments[day].label));

      for (const p of payments[day].items) {
        const row = el("div", "item paid");
        const left = el("div", "item-left");

        left.appendChild(el("div", "item-title", p.provider || "Payment"));

        const parts = [];
        if (p.display_name) {
          parts.push(
            p.display_name.toLowerCase() === "airtel"
              ? "Airtel Black"
              : p.display_name
          );
        }
        if (p.consumer_name && p.consumer_name !== p.display_name) {
          parts.push(p.consumer_name);
        }
        if (
          p.ca_number &&
          p.ca_number !== p.display_name &&
          p.ca_number !== p.consumer_name
        ) {
          parts.push(p.ca_number);
        }

        left.appendChild(el("div", "item-sub", parts.join(" | ")));
        row.append(left, el("div", "item-right", `â‚¹${formatINR(p.value)}`));
        group.appendChild(row);
      }

      sec.appendChild(group);
    }

    frag.appendChild(sec);
  }

  root.appendChild(frag);
}

/* ================= SAFE START ================= */
document.addEventListener("DOMContentLoaded", () => {
  // First paint (empty but stable)
  render({
    cards: { overdue: [], due: [], paid: [] },
    payments: {},
    summary: {}
  });

  // Fetch after first paint
  requestAnimationFrame(loadData);
});
</script>
